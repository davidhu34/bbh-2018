"use strict"
const http = require('http')
const https = require('https')
const path = require('path')
const express = require('express')
const fs = require('fs')
const axios = require('axios')
const FormData = require('form-data')
const socketio = require('socket.io')

// const multer = require('multer')
// const storage = multer.diskStorage({
//     destination: __dirname + '/tmp/my-uploads',
//     filename: function (req, file, cb) {
//     cb(null, file.fieldname + '-' + Date.now()+'.jpg')
//     }
// })
// const upload = multer({ storage: storage })


const { PORT, MONGOURI, IMAGE_API } = require('./configs')
const { normalizePort, onError, onListening } = require('./util')
const applyMiddlewares = require('./middlewares')
const api = require('./api')
// const mongo = require('./db')

const app = express()

applyMiddlewares( app )

// app.use( express.static( path.join( __dirname, '..', 'public' ) ) )
app.use( express.static( path.join( __dirname ) ) )

const port = normalizePort( process.env.PORT || PORT )
app.set( 'port', port )


const server = http.createServer( app )
console.log('server started on port',port)
// const io = new socketio(server)
// const models = mongo( MONGOURI )
// app.use( '/', api(io, models ) )
// app.use( '/', api(io, models ) )


// const image='data:image/jpeg;base64,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';

const decodeBase64Image = function(dataString) {
    const matches = dataString.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),
    response = {};

    if (!matches || matches.length !== 3) {
        // return new Error('Invalid input string');
        return null;
    }

    response.type = matches[1];
    response.data = new Buffer(matches[2], 'base64');

    return response;
}

app.get('/', function(req, res) {
    res.sendFile(path.join(__dirname + '/index.html'));
});

app.post('*/insights', function (req, res, next) {
    const data = req.body
    console.log('REQUEST GET');
    const imageBuffer = decodeBase64Image(data.image);


    if (imageBuffer) {
        const imgPath = __dirname + '/foodImage.jpg'

        fs.writeFile(imgPath, imageBuffer.data, (err) => {

            let form = new FormData();
            form.append('image', fs.createReadStream(imgPath), {
                image: 'foodImage.jpg'
            });
            console.log('FORM CREATED, SENDING AXIOS');
            axios.create({
                headers: form.getHeaders()
            }).post(IMAGE_API,form).then(response => {
                console.log('AXIOS RETURN', response.data);
                res.send(response.data)
            }).catch( error => {
                // console.log('AXIOS ERROR', error);
                res.send({ error: error })
            });
        });
    } else {
        res.send({ error: 'invalid image' })
    }

});

server.listen( port )
server.on( 'error', onError( port ) )
server.on( 'listening', onListening( server ) )
